# Interceptors Code Generation

Goa generates interceptor code to enable request/response interception and payload/result access.

---

## 1. Client & Server Interceptors

### Where They Are Generated

Client and server interceptor code is generated in:

* `gen/client_interceptors.go`
* `gen/service_interceptors.go`

### Templates Used

1. **`server_interceptors.go.tpl`** and **`client_interceptors.go.tpl`**  
   Define the server and client interceptor interface types.
   Each template takes a `Data` struct as input.

2. **`interceptors.go.tpl`**  
   Generates the payload/result access interfaces and accompanying info structs.
   This template takes a slice of `InterceptorData` as input.

3. **`client_wrappers.go.tpl`** and **`endpoint_wrappers.go.tpl`**  
   Generate code that wraps client and service endpoints with interceptor callbacks.
   Each template takes a map with:

   ```go
   map[string]any{
     "MethodVarName": <Implemented method name>
     "Method":        <Design method name>
     "Service":       <Service name>
     "Interceptors":  <Slice of InterceptorData>
   }
   ```

---

## 2. Client & Server Endpoint Wrapper Code

### Where It Is Generated

Endpoint wrapper code for both client and server interceptors is generated in:

* `gen/interceptor_wrappers.go`

### Templates Used

1. **`server_interceptor_wrappers.go.tpl`**  
   Generates server-specific wrapper implementations. This template receives a map with:

   ```go
   map[string]any{
     "Service":            svc.Name,
     "ServerInterceptors": svc.ServerInterceptors,
   }
   ```

2. **`client_interceptor_wrappers.go.tpl`**  
   Generates client-specific wrapper implementations. This template receives a map with:

   ```go
   map[string]any{
     "Service":            svc.Name,
     "ClientInterceptors": svc.ClientInterceptors,
   }
   ```

## 3. Example Interceptors

### Where They Are Generated

Example interceptors are generated by the example command in an interceptors sub-package of the user’s service package:

* Client interceptors: `<service>_client.go`
* Server interceptors: `<service>_server.go`

### Templates Used

1. **`example_client_interceptor.go.tpl` and `example_server_interceptor.go.tpl`**  
   Generate example interceptor implementations. Each template takes a map with:

   ```go
   map[string]any{
     "StructName":         <interceptor struct name>
     "ServiceName":        <service name>
     "PkgName":            <interceptors package name>
     "ServerInterceptors": <server interceptors slice>
     "ClientInterceptors": <client interceptors slice>
   }
   ```

2. **`example_service_init.go.tpl`**  
   Generates an example service implementation. This template takes a Data struct.

### Generated Example Features

The example interceptors demonstrate common interception patterns:

* Logging of request/response data
* Error handling and error logging
* Type-safe payload and result access through the generated info structs
* Context propagation across requests and responses

## 4. Data Structures

The templates above share a common set of data structures that describe
interceptor behavior, payload, result access, and streaming. These data
structures are defined as follows:

### `Data`

A service-level structure containing information for both client and server interceptors:

* `ServerInterceptors`: A slice of InterceptorData for server-side interceptors
* `ClientInterceptors`: A slice of InterceptorData for client-side interceptors

### `InterceptorData`

The main structure describing each interceptor’s metadata and requirements:

* `Name`: Generated Go name of the interceptor (CamelCase)
* `DesignName`: Original name from the design
* `Description`: Interceptor description from the design
* `HasPayloadAccess`: Indicates if any method requires payload access
* `HasResultAccess`: Indicates if any method requires result access
* `HasStreamingPayloadAccess`: Indicates if any method requires streaming payload access
* `HasStreamingResultAccess`: Indicates if any method requires streaming result access
* `ReadPayload`: List of readable payload fields ([]AttributeData)
* `WritePayload`: List of writable payload fields ([]AttributeData)
* `ReadResult`: List of readable result fields ([]AttributeData)
* `WriteResult`: List of writable result fields ([]AttributeData)
* `ReadStreamingPayload`: List of readable streaming payload fields ([]AttributeData)
* `WriteStreamingPayload`: List of writable streaming payload fields ([]AttributeData)
* `ReadStreamingResult`: List of readable streaming result fields ([]AttributeData)
* `WriteStreamingResult`: List of writable streaming result fields ([]AttributeData)
* `Methods`: A list of MethodInterceptorData containing method-specific interceptor information
* `ServerStreamInputStruct`: Server stream variable name (used if streaming)
* `ClientStreamInputStruct`: Client stream variable name (used if streaming)

### `MethodInterceptorData`

Stores per-method interceptor configuration:

* `MethodName`: The method’s Go variable name
* `PayloadAccess`: Name of the payload access type
* `ResultAccess`: Name of the result access type
* `StreamingPayloadAccess`: Name of the streaming payload access type
* `StreamingResultAccess`: Name of the streaming result access type
* `PayloadRef`: Reference to the method's payload type
* `ResultRef`: Reference to the method's result type
* `StreamingPayloadRef`: Reference to the method's streaming payload type
* `StreamingResultRef`: Reference to the method's streaming result type

### `AttributeData`

Represents per-field access configuration:

* `Name`: The field accessor method name
* `TypeRef`: Go type reference for the field
* `Type`: Underlying attribute type information
